{% extends 'search/base.html' %}
{% block title %}å…¨ç½‘èµ„æºå¼‚æ­¥æ£€ç´¢{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<header class="banner-bg min-h-[550px] flex items-center justify-center text-center text-white px-4">
    <div class="max-w-4xl w-full">
        <div class="inline-block px-4 py-1.5 mb-6 rounded-full bg-blue-500/20 border border-blue-400/30 text-blue-200 text-sm backdrop-blur-md">
            ğŸš€ æ ¸å¿ƒå¼•æ“ï¼šåŸºäºåˆ†å¸ƒå¼çˆ¬è™«é›†ç¾¤ï¼ŒæŒ–æ˜å…¨ç½‘å…¬å¼€èµ„æº
        </div>

        <h1 class="text-4xl md:text-6xl font-extrabold mb-8 tracking-tight leading-tight">
            å…¨ç½‘èµ„æº <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-cyan-300">æ·±åº¦æ£€ç´¢</span>
        </h1>

        <form id="searchForm" method="post" action="{% url 'index' %}" class="bg-white p-2.5 rounded-2xl shadow-2xl flex flex-col md:flex-row gap-2 mb-8">
            {% csrf_token %}
            <input type="text" name="keyword" placeholder="è¾“å…¥å…³é”®è¯ (å¦‚: åº†ä½™å¹´)" required class="flex-1 px-6 py-4 text-gray-800 focus:outline-none text-lg">
            <input type="email" name="email" placeholder="é€šçŸ¥é‚®ç®±" required class="md:w-1/3 px-6 py-4 text-gray-800 border-l border-gray-100 focus:outline-none text-lg">
            <button type="submit" id="submitBtn" class="bg-blue-600 hover:bg-blue-700 px-8 py-4 rounded-xl font-bold transition-all transform hover:scale-[1.02] active:scale-95 shadow-lg text-white">
                å¼€å§‹ç¦»çº¿æ£€ç´¢
            </button>
        </form>

        <label class="inline-flex items-center gap-2 text-sm text-gray-200 mb-8 select-none">
            <input type="checkbox" name="no_email" form="searchForm" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-600">
            ä¸è¦å‘é€é‚®ä»¶é€šçŸ¥ï¼ˆä»éœ€å¡«å†™é‚®ç®±ï¼‰
        </label>

        <div class="flex flex-wrap items-center justify-center gap-6 md:gap-12 text-sm md:text-base text-gray-200">
            <span class="flex items-center gap-2">
                <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                åˆ†å¸ƒé›†ç¾¤çˆ¬å–
            </span>
            <span class="flex items-center gap-2">
                <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                å¼‚æ­¥ç¦»çº¿å¤„ç†
            </span>
            <span class="flex items-center gap-2">
                <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                é‚®ä»¶ç²¾å‡†é€è¾¾
            </span>
        </div>

        {% if error %}
        <div class="mt-6 bg-red-600/90 text-white text-sm px-4 py-3 rounded-xl max-w-md mx-auto">
            {{ error }}
        </div>
        {% endif %}
    </div>
</header>

<div class="max-w-7xl mx-auto px-4 py-12">
    <div class="flex items-center justify-between mb-6">
        <h3 class="text-lg font-bold flex items-center text-gray-800">
            <span class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></span> å®æ—¶æœç´¢å¹¿åœºåŠ¨æ€
        </h3>
        <span class="text-gray-400 text-xs text-right">å·²ç´¯è®¡å¤„ç†åˆ†å¸ƒå¼æ£€ç´¢ä»»åŠ¡ 12.8k+</span>
    </div>
    
    <div class="bg-white rounded-2xl shadow-sm border divide-y overflow-hidden">
        {% for task in recent_tasks %}
        <div class="p-4 flex justify-between items-center hover:bg-gray-50 transition cursor-pointer js-task-row" data-task-id="{{ task.task_id.hex }}" data-related-task-id="{{ task.related_task_id.hex }}">
            <span class="text-gray-600 text-sm text-left">
                ç”¨æˆ· <span class="font-mono text-gray-400">{{ task.masked_email }}</span> 
                <span class="mx-2 text-gray-300">|</span> 
                <span class="text-gray-500">{{ task.created_at|date:"Y-m-d H:i:s" }}</span>
                æ­£åœ¨æ£€ç´¢ <b class="text-gray-900">{{ task.keyword }}</b>
            </span>
            <span class="text-xs px-2.5 py-1 font-medium rounded-full flex items-center gap-1.5
                {% if task.status == 'SUCCESS' %}
                    bg-green-100 text-green-700
                {% else %}
                    bg-blue-50 text-blue-600 animate-pulse
                {% endif %}">
                {% if task.status != 'SUCCESS' %}
                    <span class="w-1.5 h-1.5 bg-blue-500 rounded-full"></span>
                {% endif %}
                {{ task.get_status_display }}
            </span>
        </div>
        {% empty %}
        <div class="p-12 text-center text-gray-400 italic">
            æš‚æ— å®æ—¶åŠ¨æ€ï¼Œç«‹å³å¼€å§‹æ‚¨çš„ç¬¬ä¸€æ¬¡å…¨ç½‘æ·±åº¦æ£€ç´¢
        </div>
        {% endfor %}
    </div>
</div>

<script>
    // æ‹¦æˆªè¡¨å•æäº¤ï¼šç§’çº§åˆ‡æ¢åœºæ™¯
    document.getElementById('searchForm').onsubmit = function() {
        let btn = document.getElementById('submitBtn');
        // ç«‹å³ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤æäº¤
        btn.disabled = true;
        // ç¨å¾®æ”¹å˜æ ·å¼ï¼ˆå¦‚å˜ç°è‰²ï¼‰ï¼Œç»™ç”¨æˆ·ä¸€ä¸ªç‰©ç†åé¦ˆæ„Ÿ
        btn.classList.add('opacity-80', 'cursor-wait');
        // ä¿æŒåŸæ¥çš„æ–‡å­—ï¼Œç›´æ¥è®©æµè§ˆå™¨æ‰§è¡Œ action è·³è½¬
        return true; 
    };

    // æœç´¢å¹¿åœºçš„é€»è¾‘ä¿ç•™ï¼Œå› ä¸ºè¿™é‡Œæ¶‰åŠå¼‚æ­¥æ ¡éªŒå’Œæ‰‹åŠ¨è·³è½¬
    document.querySelectorAll('.js-task-row').forEach(function(row) {
        row.addEventListener('click', async function() {
            const taskId = row.getAttribute('data-task-id');
            const relatedTaskId = row.getAttribute('data-related-task-id');
            const { value: email } = await Swal.fire({
                title: 'éªŒè¯é‚®ç®±åæŸ¥çœ‹ç»“æœ',
                input: 'email',
                inputLabel: 'è¯·è¾“å…¥æäº¤ä»»åŠ¡æ—¶çš„é‚®ç®±åœ°å€',
                inputPlaceholder: 'name@example.com',
                showCancelButton: true,
                confirmButtonText: 'éªŒè¯å¹¶æŸ¥çœ‹',
                cancelButtonText: 'å–æ¶ˆ',
                confirmButtonColor: '#2563eb',
                inputValidator: (value) => {
                    if (!value) return 'è¯·è¾“å…¥é‚®ç®±';
                }
            });

            if (!email) return;

            try {
                const resp = await fetch(`{% url 'verify_task_email' %}?task_id=${encodeURIComponent(taskId)}&email=${encodeURIComponent(email)}`);
                const data = await resp.json().catch(() => ({}));
                if (!resp.ok || !data.ok) {
                    await Swal.fire({
                        title: 'éªŒè¯å¤±è´¥',
                        text: 'é‚®ç®±ä¸åŒ¹é…æˆ–ä»»åŠ¡ä¸å­˜åœ¨ã€‚',
                        icon: 'error',
                        confirmButtonColor: '#2563eb'
                    });
                    return;
                }
                const jumpId = data.related_task_id || relatedTaskId;
                window.location.href = `{% url 'result' %}?related_task_id=${jumpId}`;
            } catch (e) {
                console.error("Verification failed", e);
            }
        });
    });
</script>
{% endblock %}
